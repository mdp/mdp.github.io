<!doctype html><html> <head>
<meta charset=utf-8>
<title>Mark Percival</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<script>var host="mdp.github.io";host==window.location.host&&window.location.protocol!="https:"&&(window.location=window.location.toString().replace(/^http:/,"https:"))</script>
<link rel="shortcut icon" href=/img/icon.png>
<link rel=apple-touch-icon href=/img/icon_128.png>
<link href="https://fonts.googleapis.com/css?family=Oswald:400,700" rel=stylesheet type=text/css>
<link href="https://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic" rel=stylesheet type=text/css>
<meta name=author content="Mark Percival">
<meta name=description content="Mark Percival - Professional typist, man about town, person of interest">
<link rel=stylesheet href=/css/h5bp.css>
<link rel=stylesheet type=text/css media=all href=/css/skeleton.css>
<link rel=stylesheet type=text/css media=all href=/css/layout.css>
<link rel=stylesheet type=text/css media=all href=/css/master.css>
<link rel=stylesheet type=text/css media=all href=/css/pygments.css>
<link rel=stylesheet type=text/css media=all href=/css/main.css>
</head><body><div class=container>
<main>
<div id=header class="four alpha">
<h1><a href=/>MARK PERCIVAL</a></h1>
</div>
<article>
<div class=title>
<h2 class=title>Hacking HTTPS -> HTTP referrers</h1>
<div class="meta data">May 28, 2013</div>
</div>
<div id=post class="twelve columns alpha">
<p>There was an <a href=http://smerity.com/articles/2013/where_did_all_the_http_referrers_go.html>interesting article</a> today on HTML5’s solution to solving the missing referrers problem in HTTPS -> HTTP transitions. But I thought I’d describe how Twitter’s t.co ‘fixed’ the problem.</p>
<h2 id=background>Background</h2>
<p>The root of this problem is that when you click any HTTP link on an HTTPS hosted page the browser will strip any referrer info.</p>
<p>HTML5 is now allowing you to rectify this with a ‘meta’ tag to inform the browser that your HTTPS page outbound traffic is allowed to carry the referrer information to HTTP sites. This apparently has support from the most recent releases of Chrome and Safari.</p>
<p>But what if you want to send the information regardless, even with an old browser. Lets look at the way Twitter solved the problem with their URL shortener service ‘t.co’.</p>
<p>When you click a link on Twitter, you’re actually clicking on a ‘t.co’ link which redirects you to the final URL. But it’s not performing a 302 like many other shorteners.</p>
<p>Unfortunately the way 302/301 redirects work is to send the originating pages referrer data along to the final destination.</p>
<p>For example, lets say your on ‘http://www.cnn.com’ and you click on a link to ‘http://bit.ly/1autubB’. Bit.ly will redirect you via 301 to the destination URL, and your browser will send the referrer headers containing ‘www.cnn.com’.</p>
<p>Unfortunately this doesn’t work on HTTPS. If you’re Twitter, and someone clicks on that Bit.ly link, the originating page is HTTPS and the destination is HTTP, so the browser will strip the referrer information from the request. And since Twitter is 100% HTTPS, this means that they would lose all credit for traffic directed to any non-HTTPS site.</p>
<h2 id=the-solution>The Solution</h2>
<p>So while Bit.ly uses a 301 to redirect users, Twitter uses a 200 and this:</p>
<pre><code>curl 'http://t.co/9CQXgns5U5'
</code></pre>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>noscript</span>&gt;&lt;<span style=color:#f92672>META</span> <span style=color:#a6e22e>http-equiv</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;refresh&#34;</span> <span style=color:#a6e22e>content</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0;URL=http://bits.blogs.nytimes.com/2013/05/26/disruptions-at-odds-over-privacy-challenges-of-wearable-computing/&#34;</span>&gt;&lt;/<span style=color:#f92672>noscript</span>&gt;&lt;<span style=color:#f92672>body</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://bits.blogs.nytimes.com/2013/05/26/disruptions-at-odds-over-privacy-challenges-of-wearable-computing/&#34;</span>&gt;&lt;/<span style=color:#f92672>a</span>&gt;&lt;<span style=color:#f92672>script</span>&gt;document.<span style=color:#a6e22e>getElementsByTagName</span>(<span style=color:#e6db74>&#34;a&#34;</span>)[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>click</span>();&lt;/<span style=color:#f92672>script</span>&gt;&lt;/<span style=color:#f92672>body</span>&gt;
</code></pre></div><p>They’re returning a 200 and subsequent HTML page with embedded javascript that ‘clicks’ the destination URL. The browser treats this as the originating page and sends along the referrer to ‘t.co/9CQXgns5U5’. If the browser has javascript disabled, the ‘meta refresh’ tag will still redirect them (although sans referrer in most cases).</p>
<p>Now the NYTimes knows this came from t.co and therefore most likely from Twitter. It’s a hack, but one that results in Twitter being able to use HTTPS and not lose credit as the source of traffic.</p>
</div>
<div class=post-tags>
<nav class="nav tags">
<ul class=tags>
<li><a href=/tags/github>github</a></li>
<li><a href=/tags/gist>gist</a></li>
<li><a href=/tags/curl>curl</a></li>
<li><a href=/tags/nodejs>nodejs</a></li>
</ul>
</nav>
</div>
</article><div id=footer class="sixteen columns alpha light">
© Mark Percival 2025
</div></main>
</div>
</body>
</html>